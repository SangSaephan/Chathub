From b7732a4ed2994eb036ff100770386675dd326631 Mon Sep 17 00:00:00 2001
From: Sang Saephan <sangsaephan510@yahoo.com>
Date: Tue, 13 Sep 2016 10:34:40 -0700
Subject: [PATCH] Initial chathub setup

---
 app/google-services.json                           | 55 ++++++++++++++++++++++
 .../java/edu/sfsu/csc780/chathub/MainActivity.java | 30 +++++++++++-
 .../edu/sfsu/csc780/chathub/SignInActivity.java    | 28 +++++++++++
 local.properties                                   |  5 +-
 4 files changed, 113 insertions(+), 5 deletions(-)
 create mode 100644 app/google-services.json

diff --git a/app/google-services.json b/app/google-services.json
new file mode 100644
index 0000000..df3bb83
--- /dev/null
+++ b/app/google-services.json
@@ -0,0 +1,55 @@
+{
+  "project_info": {
+    "project_number": "594555583715",
+    "firebase_url": "https://chathub-project-8e26c.firebaseio.com",
+    "project_id": "chathub-project-8e26c",
+    "storage_bucket": "chathub-project-8e26c.appspot.com"
+  },
+  "client": [
+    {
+      "client_info": {
+        "mobilesdk_app_id": "1:594555583715:android:123c68aba501e686",
+        "android_client_info": {
+          "package_name": "edu.sfsu.csc780.chathub"
+        }
+      },
+      "oauth_client": [
+        {
+          "client_id": "594555583715-oik5gdse2rj4e20othlhfj6a1aobbor3.apps.googleusercontent.com",
+          "client_type": 1,
+          "android_info": {
+            "package_name": "edu.sfsu.csc780.chathub",
+            "certificate_hash": "2FC94170D9A7F0E8EC8175A4415C5433E666C109"
+          }
+        },
+        {
+          "client_id": "594555583715-v582r0nqis5odfpo6p0o48a11589aa7p.apps.googleusercontent.com",
+          "client_type": 3
+        }
+      ],
+      "api_key": [
+        {
+          "current_key": "AIzaSyAz6y4WhPEFObA9RfkJ9N9Xs5_7-cRDSVw"
+        }
+      ],
+      "services": {
+        "analytics_service": {
+          "status": 1
+        },
+        "appinvite_service": {
+          "status": 2,
+          "other_platform_oauth_client": [
+            {
+              "client_id": "594555583715-v582r0nqis5odfpo6p0o48a11589aa7p.apps.googleusercontent.com",
+              "client_type": 3
+            }
+          ]
+        },
+        "ads_service": {
+          "status": 2
+        }
+      }
+    }
+  ],
+  "configuration_version": "1"
+}
\ No newline at end of file
diff --git a/app/src/main/java/edu/sfsu/csc780/chathub/MainActivity.java b/app/src/main/java/edu/sfsu/csc780/chathub/MainActivity.java
index 77ba1fd..56672ce 100644
--- a/app/src/main/java/edu/sfsu/csc780/chathub/MainActivity.java
+++ b/app/src/main/java/edu/sfsu/csc780/chathub/MainActivity.java
@@ -15,6 +15,7 @@
  */
 package edu.sfsu.csc780.chathub;
 
+import android.content.Intent;
 import android.content.SharedPreferences;
 import android.os.Bundle;
 import android.preference.PreferenceManager;
@@ -40,6 +41,8 @@ import android.widget.Toast;
 import com.google.android.gms.auth.api.Auth;
 import com.google.android.gms.common.ConnectionResult;
 import com.google.android.gms.common.api.GoogleApiClient;
+import com.google.firebase.auth.FirebaseAuth;
+import com.google.firebase.auth.FirebaseUser;
 
 import de.hdodenhof.circleimageview.CircleImageView;
 
@@ -76,6 +79,8 @@ public class MainActivity extends AppCompatActivity
     private EditText mMessageEditText;
 
     // Firebase instance variables
+    private FirebaseAuth mAuth;
+    private FirebaseUser mUser;
 
     @Override
     protected void onCreate(Bundle savedInstanceState) {
@@ -85,6 +90,18 @@ public class MainActivity extends AppCompatActivity
         // Set default username is anonymous.
         mUsername = ANONYMOUS;
         //Initialize Auth
+        mAuth = FirebaseAuth.getInstance();
+        mUser = mAuth.getCurrentUser();
+        if(mUser == null){
+            startActivity(new Intent(this, SignInActivity.class));
+            finish();
+            return;
+        } else {
+            mUsername = mUser.getDisplayName();
+            if(mUser.getPhotoUrl() != null){
+                mPhotoUrl = mUser.getPhotoUrl().toString();
+            }
+        }
 
         mGoogleApiClient = new GoogleApiClient.Builder(this)
                 .enableAutoManage(this /* FragmentActivity */, this /* OnConnectionFailedListener */)
@@ -162,7 +179,16 @@ public class MainActivity extends AppCompatActivity
 
     @Override
     public boolean onOptionsItemSelected(MenuItem item) {
-        return super.onOptionsItemSelected(item);
+        switch(item.getItemId()){
+            case R.id.sign_out_menu:
+                mAuth.signOut();
+                Auth.GoogleSignInApi.signOut(mGoogleApiClient);
+                mUsername = ANONYMOUS;
+                startActivity(new Intent(this, SignInActivity.class));
+                return true;
+            default:
+                return super.onOptionsItemSelected(item);
+        }
     }
 
     @Override
@@ -172,4 +198,4 @@ public class MainActivity extends AppCompatActivity
         Log.d(TAG, "onConnectionFailed:" + connectionResult);
         Toast.makeText(this, "Google Play Services error.", Toast.LENGTH_SHORT).show();
     }
-}
+}
\ No newline at end of file
diff --git a/app/src/main/java/edu/sfsu/csc780/chathub/SignInActivity.java b/app/src/main/java/edu/sfsu/csc780/chathub/SignInActivity.java
index 5a0bf59..5c6f623 100644
--- a/app/src/main/java/edu/sfsu/csc780/chathub/SignInActivity.java
+++ b/app/src/main/java/edu/sfsu/csc780/chathub/SignInActivity.java
@@ -26,6 +26,7 @@ import android.widget.Toast;
 import com.google.android.gms.auth.api.Auth;
 import com.google.android.gms.auth.api.signin.GoogleSignInAccount;
 import com.google.android.gms.auth.api.signin.GoogleSignInOptions;
+import com.google.android.gms.auth.api.signin.GoogleSignInResult;
 import com.google.android.gms.common.ConnectionResult;
 import com.google.android.gms.common.SignInButton;
 import com.google.android.gms.common.api.GoogleApiClient;
@@ -72,12 +73,14 @@ public class SignInActivity extends AppCompatActivity implements
 
         // Initialize FirebaseAuth
         //Initialize Auth
+        mAuth = FirebaseAuth.getInstance();
     }
 
     @Override
     public void onClick(View v) {
         switch (v.getId()) {
             case R.id.sign_in_button:
+                signIn();
                 break;
         }
     }
@@ -94,6 +97,16 @@ public class SignInActivity extends AppCompatActivity implements
     public void onActivityResult(int requestCode, int resultCode, Intent data) {
         super.onActivityResult(requestCode, resultCode, data);
         // Handle the result of the sign-in activity
+        if(requestCode == RC_SIGN_IN) {
+            GoogleSignInResult result = Auth.GoogleSignInApi.getSignInResultFromIntent(data);
+            if(result.isSuccess()) {
+                //successful, now authenticate with Firebase
+                GoogleSignInAccount account = result.getSignInAccount();
+                firebaseAuthWithGoogle(account);
+            } else {
+                Log.e(TAG, "Google Sign In failed.");
+            }
+        }
     }
 
     private void firebaseAuthWithGoogle(GoogleSignInAccount acct) {
@@ -103,7 +116,22 @@ public class SignInActivity extends AppCompatActivity implements
                     @Override
                     public void onComplete(@NonNull Task<AuthResult> task) {
                         // Process the auth task result
+                        Log.d(TAG, "signInWithCredential:onComplete:" + task.isSuccessful());
+                        // If sign in fails, display a message to the user.
+                        // If sign in succeeds, start MainActivity and finish this activity
+                        if(!task.isSuccessful()) {
+                            Log.w(TAG, "signInWithCredential", task.getException());
+                            Toast.makeText(SignInActivity.this, "Authentication failed.", Toast.LENGTH_SHORT).show();
+                        } else {
+                            startActivity(new Intent(SignInActivity.this, MainActivity.class));
+                            finish();
+                        }
                     }
                 });
     }
+
+    private void signIn() {
+        Intent signInIntent = Auth.GoogleSignInApi.getSignInIntent(mGoogleApiClient);
+        startActivityForResult(signInIntent, RC_SIGN_IN);
+    }
 }
diff --git a/local.properties b/local.properties
index 968b937..fe15ca7 100644
--- a/local.properties
+++ b/local.properties
@@ -7,6 +7,5 @@
 # Location of the SDK. This is only used by Gradle.
 # For customization when using a Version Control System, please read the
 # header note.
-#Sat Aug 06 13:05:05 PDT 2016
-ndk.dir=/Users/cjkriese/Library/Android/sdk/ndk-bundle
-sdk.dir=/Users/cjkriese/Library/Android/sdk
+#Tue Sep 13 08:28:10 PDT 2016
+sdk.dir=/Users/SangSaephan/Library/Android/sdk
-- 
2.5.4 (Apple Git-61)

